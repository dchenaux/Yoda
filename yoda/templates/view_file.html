{% extends "layout.html" %}

{% block styles %}
    {{super()}}
    <link rel="stylesheet" href="{{url_for('static', filename='default.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='pygments/code.css')}}">
{% endblock %}

{% block scripts %}
    {{super()}}
    <script type="text/javascript">

    /* Script for all the panel functions */
    $(document).ready(function(){

        /* Show or hide all panels */
        $('#bt-showall').click(function(){
            $('[id^=panel-]').fadeIn('slow');
        })
        $('#bt-closeall').click(function(){
            $('[id^=panel-]').fadeOut('slow');
        })

        /* Single panel functions */

        // When click event on a line number occurs, open the corresponding panel
        $('a[href*="#-"]').click(function(){
            var panelno = $(this).attr('href').replace(/[^0-9\.]/g, '');
            $('div[id^="panel-"][id$="-'+panelno+'"]').fadeIn( 'fast' );
        });
        // When clicking on a frame name, show all the corresponding panels
        $('a[href^="#showframe-"]').click(function(){
            var frame = $(this).attr('href').replace('#showframe-','');
            $('div[id^="panel-'+frame+'-"]').fadeIn( 'slow' );
        });
        // When clicking on the close button, close the corresponding panel
        $('button[id^="close-"]').click(function(){
            id = $(this).attr('id').replace('close-','');
            $('div[id="panel-'+id+'"]').fadeOut( 'slow' );
        });

    });
    </script>
   <script type="text/javascript">
       $(function() {
           $('.inlinesparkline').sparkline('html', {
               type: 'line',
               disableHiddenCheck: true,
               disableInteraction: true,
               height: '20px',
               width: '100px'
           });
       });
   </script>

    <script type="text/javascript">
        /* Initialisation of toolboxes */
        $(function () {
          $('[data-toggle="tooltip"]').tooltip()
        });
    </script>

    <script type=text/javascript src="{{ url_for('static', filename='highcharts.js') }}"></script>
    <script type=text/javascript src="{{ url_for('static', filename='highcharts-data.js') }}"></script>
    <script type="text/javascript">
    /* TODO: The graph is completly wrong with loops */
    // Why ? Because all the data begin a the left corner instead at the right point
    /* TODO : Load data through AJAX in order to remove PHP in JS */

        $(function () {

            var url = $(location).attr('href').split('/');
            var id = url[url.length-1];

            // Get the CSV and create the chart
            $.getJSON($SCRIPT_ROOT + '/_file_details/'+id, function (csv) {
                console.log(csv);

                $('#container').highcharts({

                    data: {
                        csv: csv
                    },

                    title: {
                        text: 'Daily visits at www.highcharts.com'
                    },

                    subtitle: {
                        text: 'Source: Google Analytics'
                    },

                    xAxis: {
                        tickInterval: 7 * 24 * 3600 * 1000, // one week
                        tickWidth: 0,
                        gridLineWidth: 1,
                        labels: {
                            align: 'left',
                            x: 3,
                            y: -3
                        }
                    },

                    yAxis: [{ // left y axis
                        title: {
                            text: null
                        },
                        labels: {
                            align: 'left',
                            x: 3,
                            y: 16,
                            format: '{value:.,0f}'
                        },
                        showFirstLabel: false
                    }, { // right y axis
                        linkedTo: 0,
                        gridLineWidth: 0,
                        opposite: true,
                        title: {
                            text: null
                        },
                        labels: {
                            align: 'right',
                            x: -3,
                            y: 16,
                            format: '{value:.,0f}'
                        },
                        showFirstLabel: false
                    }],

                    legend: {
                        align: 'left',
                        verticalAlign: 'top',
                        y: 20,
                        floating: true,
                        borderWidth: 0
                    },

                    tooltip: {
                        shared: true,
                        crosshairs: true
                    },

                    plotOptions: {
                        series: {
                            cursor: 'pointer',
                            point: {
                                events: {
                                    click: function (e) {
                                        hs.htmlExpand(null, {
                                            pageOrigin: {
                                                x: e.pageX || e.clientX,
                                                y: e.pageY || e.clientY
                                            },
                                            headingText: this.series.name,
                                            maincontentText: Highcharts.dateFormat('%A, %b %e, %Y', this.x) + ':<br/> ' +
                                                this.y + ' visits',
                                            width: 200
                                        });
                                    }
                                }
                            },
                            marker: {
                                lineWidth: 1
                            }
                        }
                    },

                    series: [{
                        name: 'All visits',
                        lineWidth: 4,
                        marker: {
                            radius: 4
                        }
                    }, {
                        name: 'New visitors'
                    }]
                });
            });

        });

    </script>

    <script type=text/javascript src="{{ url_for('static', filename='jquery.sparkline.min.js') }}"></script>
{% endblock %}

{% block content %}
    <!-- TODO : avoid full page scroll -->
    <div class="container-fluid">
        {% for file in file %}
            <div class="container">
                <h2>{{ file.filename }}</h2>
                <p>Revision : {{file.revision}}, Date : {{file.timestamp.strftime('%d-%m-%Y %H:%M:%S')}}</p>
                <div id="container{{file.id}}" style="min-width: 310px; max-width: 1000px; margin: 50px auto"></div>
            </div>
            <div class="row">
                <!-- File source -->
                <div class="col-md-7" id="file-source-col">
                    {% include "partials/filesource.html" %}
                </div>
                <!-- End of file source -->

                <div class="col-md-5" id="data-col">
                    <div class="row" style="margin: 5px;">
                        <div class="alert alert-info" role="alert">
                            Click on a frame name or a line number to get details or choose to show them all at once by
                            clicking the following button.
                        </div>
                        <p>
                            <div class="btn-group pull-right" role="group" aria-label="..." style="margin-bottom: 1em">
                                <button type="button" class="btn btn-default" id="bt-showall">Show all</button>
                                <button type="button" class="btn btn-default" id="bt-closeall">Close all</button>
                            </div>
                            Analysed frames :
                            {% for frame in file.frames %}
                                <a href="#showframe-{{ frame.name|replace("<", "")|replace(">", "") }}">{{ frame.name }}</a>
                            {% endfor %}
                        </p>
                    </div>
                    <div class="row" id="data-col-row">
                    {% for frame in file.frames %}
                        {% for line in frame.lines %}
                            <!-- Panel for each line -->
                            <div class="panel panel-default collapse" id="panel-{{ frame.name|replace("<", "")|replace(">", "") }}-{{ line.lineno }}">
                                <div class="panel-heading">
                                    {{ frame.name|replace("<", "")|replace(">", "") }} - {{ line.lineno }}
                                    <button class="close" id="close-{{ frame.name|replace("<", "")|replace(">", "") }}-{{ line.lineno }}">&times;</button>
                                </div>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Object</th>
                                            <th>Values</th>
                                            <th>Graph</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {% for k,v in line.data.items()|sort %}
                                        <tr>
                                            <td>{{ k }}</td>
                                            <td>{{ v }}</td>
                                            <td>
                                                <span class="inlinesparkline">
                                                    {{ v|replace("[", "")|replace("]", "") }}
                                                </span>
                                            </td>
                                        </tr>
                                    {%endfor%}
                                    </tbody>
                                </table>
                            </div>
                            <!-- end of panel -->
                        {% endfor %}
                    {% endfor %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock %}